services:
  eval:
    build:
      context: .  # Resolved via --project-directory to project root
      dockerfile: tools/eval/Dockerfile
    image: attocode-eval  # Tag the built image so dashboard can reuse it
    volumes:
      # Persist eval results (paths relative to --project-directory)
      - ./tools/eval/results:/app/tools/eval/results
      # Write traces to project root .traces/ for dashboard visibility
      - ./.traces:/app/.traces
      # Mount datasets for custom evaluation sets
      - ./tools/eval/datasets:/app/tools/eval/datasets:ro
      # Docker socket for SWE-bench harness (creates per-instance containers)
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # API keys (passed from host environment)
      - ANTHROPIC_API_KEY
      - OPENROUTER_API_KEY
      - OPENAI_API_KEY
      # SWE-bench configuration
      - SWE_BENCH_LIMIT
      - SWE_BENCH_INSTANCE_IDS
      # Trace output directory (inside container)
      - TRACE_OUTPUT_DIR=/app/.traces
    working_dir: /app
    # Enable pseudo-TTY for better output
    tty: true
    stdin_open: true

  # Convenience service to run the trace dashboard
  dashboard:
    image: attocode-eval  # Reuse the eval image (no separate build)
    volumes:
      - ./.traces:/app/.traces:ro
      - ./tools/eval/results:/app/tools/eval/results:ro
    ports:
      - "3000:5173"  # Vite dev server (host 3000 → container 5173)
      - "4000:3001"  # Hono API server (host 4000 → container 3001)
    working_dir: /app/tools/trace-dashboard
    command: npm run dev
    environment:
      - NODE_ENV=development
